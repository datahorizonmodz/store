<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PREMIUM LIST | Subscription Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-color: #ffffff;
            --surface-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --accent: #22c55e;
            --border: #e2e8f0;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --surface-color: #1e293b;
            --card-bg: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --accent: #4ade80;
            --border: #334155;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Quicksand', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); min-height: 100vh; transition: 0.3s; }

        header { position: sticky; top: 0; z-index: 100; background: var(--bg-color); border-bottom: 1px solid var(--border); padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        header h1 { font-size: 1.25rem; font-weight: 700; color: var(--accent); }

        #search-wrapper { max-height: 0; overflow: hidden; transition: 0.4s; background: var(--surface-color); }
        #search-wrapper.open { max-height: 80px; border-bottom: 1px solid var(--border); }
        .search-container { padding: 1rem 1.5rem; max-width: 800px; margin: 0 auto; }
        .search-container input { width: 100%; padding: 0.7rem 1rem; border-radius: 12px; border: 1px solid var(--border); background: var(--bg-color); color: var(--text-main); outline: none; }

        .summary-section { padding: 1rem 1.5rem; max-width: 1200px; margin: 0 auto; }
        .summary-line { font-size: 0.8rem; color: var(--accent); margin-bottom: 0.2rem; }

        .cards-container { padding: 1.5rem; max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 20px; padding: 1.5rem; box-shadow: var(--shadow); cursor: pointer; transition: 0.3s; animation: slideUp 0.5s ease-out forwards; }
        .card:hover { transform: translateY(-5px); border-color: var(--accent); }

        .badge { font-size: 0.7rem; font-weight: 700; padding: 0.2rem 0.6rem; border-radius: 10px; text-transform: uppercase; }
        .badge-active { background: #dcfce7; color: #166534; }

        #modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 1rem; }
        .modal-content { background: var(--card-bg); padding: 2rem; border-radius: 24px; width: 100%; max-width: 450px; }

        .close-btn { margin-top: 1.5rem; width: 100%; padding: 0.8rem; border: none; background: var(--accent); color: white; border-radius: 12px; font-weight: 700; cursor: pointer; }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .status-msg { grid-column: 1/-1; text-align: center; padding: 4rem; color: var(--text-muted); }
    </style>
</head>
<body data-theme="light">

    <header>
        <h1>PREMIUM LIST</h1>
        <div style="display: flex; gap: 0.5rem;">
            <button id="search-toggle" style="background:none; border:none; color:inherit; cursor:pointer; padding:0.5rem;"><i data-lucide="search" id="search-icon"></i></button>
            <button id="theme-toggle" style="background:none; border:none; color:inherit; cursor:pointer; padding:0.5rem;"><i data-lucide="sun" id="theme-icon"></i></button>
        </div>
    </header>

    <div id="search-wrapper">
        <div class="search-container">
            <input type="text" id="search-input" placeholder="Cari nama atau nomor HP...">
        </div>
    </div>

    <section class="summary-section" id="summary-container"></section>

    <main class="cards-container" id="cards-grid">
        <div class="status-msg" id="status-display">Menghubungkan ke Firebase...</div>
    </main>

    <div id="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-bottom: 1rem;">Detail Langganan</h3>
            <div id="modal-data" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;"></div>
            <button class="close-btn" id="close-modal">Tutup</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfigurasi dari Screenshot 258451
        const firebaseConfig = {
            apiKey: "AIzaSyAJxH3uodX0yStj7s3JWj7gWm0LToVbtxs",
            authDomain: "listwink-5fdec.firebaseapp.com",
            projectId: "listwink-5fdec",
            storageBucket: "listwink-5fdec.firebasestorage.app",
            messagingSenderId: "817064940204",
            appId: "1:817064940204:web:844bf84691bf0ce9000509",
            measurementId: "G-QMWBNXNX9M"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let subscriptions = [];
        let searchTerm = "";

        const statusDisplay = document.getElementById('status-display');
        const cardsGrid = document.getElementById('cards-grid');

        // Fungsi Start
        async function start() {
            try {
                // Mencoba Login
                await signInAnonymously(auth);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("Login Berhasil");
                        fetchData();
                    }
                });
            } catch (err) {
                console.error("Gagal Login:", err.code);
                if (err.code === 'auth/operation-not-allowed') {
                    statusDisplay.innerHTML = "<b style='color:red'>ERROR:</b> Anonymous Auth belum aktif di Firebase Console!";
                } else {
                    statusDisplay.innerText = "Error: " + err.message;
                }
            }
        }

        function fetchData() {
            // Sesuai screenshot 258448, nama koleksinya 'subscriptions'
            const ref = collection(db, 'subscriptions');
            
            onSnapshot(ref, (snap) => {
                if (snap.empty) {
                    statusDisplay.innerText = "Koleksi 'subscriptions' ditemukan tapi tidak ada data.";
                    subscriptions = [];
                } else {
                    subscriptions = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    statusDisplay.classList.add('hidden'); // Sembunyikan pesan loading
                }
                render();
            }, (err) => {
                statusDisplay.innerText = "Gagal tarik data: " + err.message;
            });
        }

        function render() {
            const term = searchTerm.toLowerCase();
            const filtered = subscriptions.filter(s => 
                (s.customerName || "").toLowerCase().includes(term) || 
                (s.phone || "").toLowerCase().includes(term)
            );

            // Render Summary
            const summCont = document.getElementById('summary-container');
            summCont.innerHTML = '';
            subscriptions.slice(0, 3).forEach(s => {
                const rem = (s.totalCycles || 0) - (s.usedCycles || 0);
                const p = document.createElement('p');
                p.className = 'summary-line';
                p.innerText = rem > 0 
                    ? `${s.phone} ${s.customerName} : Renew ${s.product} sisa ${rem}x`
                    : `${s.phone} ${s.customerName} : ${s.product} Selesai`;
                summCont.appendChild(p);
            });

            // Render Cards
            cardsGrid.innerHTML = '';
            if (filtered.length === 0 && subscriptions.length > 0) {
                cardsGrid.innerHTML = '<div class="status-msg">Hasil cari tidak ada.</div>';
                return;
            }

            filtered.forEach(s => {
                const rem = (s.totalCycles || 0) - (s.usedCycles || 0);
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:1rem">
                        <span style="font-weight:700">${s.customerName}</span>
                        <span class="badge badge-active">${s.status}</span>
                    </div>
                    <p style="font-size:0.85rem; color:var(--text-muted)">${s.phone}</p>
                    <div style="margin-top:1rem; border-top:1px dashed var(--border); padding-top:1rem; display:flex; justify-content:space-between">
                        <span style="color:var(--accent); font-weight:600">${s.product}</span>
                        <span style="font-size:0.8rem">Sisa: <b>${rem}x</b></span>
                    </div>
                `;
                card.onclick = () => {
                    const date = s.createdAt?.seconds ? new Date(s.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';
                    document.getElementById('modal-data').innerHTML = `
                        <div><small>Nama</small><p><b>${s.customerName}</b></p></div>
                        <div><small>HP</small><p><b>${s.phone}</b></p></div>
                        <div><small>Produk</small><p><b>${s.product}</b></p></div>
                        <div><small>Plan</small><p><b>${s.plan}</b></p></div>
                        <div><small>Sisa</small><p><b>${rem}x</b></p></div>
                        <div><small>Tanggal</small><p><b>${date}</b></p></div>
                    `;
                    document.getElementById('modal-overlay').style.display = 'flex';
                };
                cardsGrid.appendChild(card);
            });
            lucide.createIcons();
        }

        // Search Logic
        document.getElementById('search-toggle').onclick = () => {
            const w = document.getElementById('search-wrapper');
            const icon = document.getElementById('search-icon');
            w.classList.toggle('open');
            if(w.classList.contains('open')) {
                icon.setAttribute('data-lucide', 'x');
                document.getElementById('search-input').focus();
            } else {
                icon.setAttribute('data-lucide', 'search');
                searchTerm = ""; document.getElementById('search-input').value = ""; render();
            }
            lucide.createIcons();
        };

        document.getElementById('search-input').oninput = (e) => { searchTerm = e.target.value; render(); };
        document.getElementById('close-modal').onclick = () => document.getElementById('modal-overlay').style.display = 'none';
        
        document.getElementById('theme-toggle').onclick = () => {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            const next = isDark ? 'light' : 'dark';
            document.body.setAttribute('data-theme', next);
            document.getElementById('theme-icon').setAttribute('data-lucide', next === 'light' ? 'sun' : 'moon');
            lucide.createIcons();
        };

        start();
    </script>
</body>
</html>

